// REFACTORISATION ACTIVE-SESSION.TSX
// Changements cl√©s pour utiliser le syst√®me centralis√© de notifications

// 1. AJOUTER L'IMPORT
import { notify, notifyConfirmation } from '@/lib/services/notification.service';

// 2. REMPLACER LES MESSAGES HARDCOD√âS

// Avant (ligne 321-334):
/*
  const handleCompleteSession = async () => {
    Alert.alert(
      'Terminer la sortie ?',
      'Etes-vous sur de vouloir terminer cette sortie ?',
      [
        { text: 'Annuler', style: 'cancel' },
        {
          text: 'Terminer',
          style: 'destructive',
          onPress: async () => {
            await _completeSession();
          },
        },
      ]
    );
  };
*/

// Apr√®s:
const handleCompleteSession = async () => {
  notifyConfirmation('confirm.stop_trip', {
    onConfirm: async () => {
      await _completeSession();
    },
  });
};

// 3. REMPLACER LES NOTIFICATIONS D'EXTENSION (ligne 378-384)

// Avant:
/*
  const handleExtendSession = async () => {
    await addTimeToSession(15);
    logger.debug('üîî [Notification] Envoi notification d\'extension (+15 min)');
    sendNotification({
      title: '‚úÖ +15 minutes ajout√©es',
      body: 'Nouvelle heure limite : ' + new Date(currentSession!.deadline + 15 * 60 * 1000).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
      data: { type: 'extension_confirmed' },
    });
  };
*/

// Apr√®s:
const handleExtendSession = async () => {
  await addTimeToSession(15);
  notify('trip.extended', {
    variables: { minutes: 15 }
  });
};

// 4. REMPLACER LES NOTIFICATIONS DE CONFIRMATION SMS (ligne 359-363)

// Avant:
/*
        if (result.ok) {
          logger.debug('‚úÖ SMS de confirmation envoy√©:', result.sid);
          sendNotification({
            title: '‚úÖ Contact rassur√©',
            body: `${settings.emergencyContactName} a √©t√© inform√© que vous √™tes bien rentr√©`,
            data: { type: 'confirmation_sent' },
          });
        }
*/

// Apr√®s:
if (result.ok) {
  logger.debug('‚úÖ SMS de confirmation envoy√©:', result.sid);
  notify('trip.checked_in');
}

// 5. REMPLACER LES NOTIFICATIONS D'ALERTE D√âCLENCH√âE (ligne 258-262)

// Avant:
/*
          sendNotification({
            title: 'üö® Oups‚Ä¶ on a pr√©venu ton contact',
            body: 'üò¨ Confirme si tout va bien.',
            data: { type: 'alert_triggered' },
          });
*/

// Apr√®s:
notify('alert.sent', {
  variables: { contactName: settings.emergencyContactName || 'ton contact' }
});

// 6. REMPLACER LES CONFIRMATIONS D'ANNULATION (ligne 408-430)

// Avant:
/*
  const handleCancelSession = () => {
    Alert.alert(
      'Annuler la sortie',
      '√ätes-vous s√ªr de vouloir annuler cette sortie ?',
      [
        { text: 'Non', style: 'cancel' },
        {
          text: 'Oui',
          style: 'destructive',
          onPress: async () => {
            await cancelAllNotifications();
            if (settings.locationEnabled && location) {
              logger.debug('Position captur√©e:', location);
            }
            await cancelSession();
            router.push('/');
          },
        },
      ]
    );
  };
*/

// Apr√®s:
const handleCancelSession = () => {
  notifyConfirmation('confirm.stop_trip', {
    onConfirm: async () => {
      await cancelAllNotifications();
      if (settings.locationEnabled && location) {
        logger.debug('Position captur√©e:', location);
      }
      await cancelSession();
      notify('trip.cancelled');
      router.push('/');
    },
  });
};

// 7. REMPLACER LES MESSAGES D'ERREUR SMS (ligne 299-303)

// Avant:
/*
              Alert.alert(
                '‚ö†Ô∏è Erreur SMS de relance',
                `Impossible d'envoyer le SMS de relance: ${error.message || 'Erreur inconnue'}`,
                [{ text: 'OK' }]
              );
*/

// Apr√®s:
notify('error.sms_failed');

// 8. REMPLACER LES CONFIRMATIONS DE CHECK-IN (ligne 387-392)

// Avant:
/*
  const handleConfirmCheckIn = async () => {
    await cancelAllNotifications();
    await confirmCheckIn();
    setShowCheckInModal(false);
  };
*/

// Apr√®s:
const handleConfirmCheckIn = async () => {
  await cancelAllNotifications();
  await confirmCheckIn();
  notify('trip.checked_in');
  setShowCheckInModal(false);
};

// 9. REMPLACER LES NOTIFICATIONS PROGRAMM√âES (ligne 195-231)

// Avant (messages hardcod√©s dans scheduleNotification):
/*
  scheduleNotification({
    title: '‚ö†Ô∏è Petit check',
    body: 'Tout va bien ? üòä Confirme ton retour dans 5 minutes.',
    ...
  });
  
  scheduleNotification({
    title: '‚è∞ Heure de retour d√©pass√©e',
    body: 'Confirme que tout va bien ! Sinon tes contacts seront alert√©s dans 15 min.',
    ...
  });
*/

// Apr√®s: Utiliser des cl√©s de notification
// Note: Les notifications programm√©es restent comme est (pas de syst√®me centralis√© pour les notifications programm√©es)
// Mais les messages peuvent √™tre extraits dans une config s√©par√©e si n√©cessaire

// R√âSUM√â DES CHANGEMENTS
// - Suppression de ~50 lignes de messages hardcod√©s
// - Utilisation de 4 fonctions centralis√©es: notify(), notifyConfirmation()
// - Coh√©rence avec le reste de l'app
// - Facilit√© de maintenance et traduction
